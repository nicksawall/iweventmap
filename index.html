<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Irreverent Warriors Event Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Papa Parse (robust CSV parsing) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .popup h3 { margin: 0 0 4px; font-size: 16px; }
    .popup .meta { font-size: 13px; margin: 2px 0; color: #333; }
    .popup .desc { margin-top: 6px; white-space: pre-wrap; max-width: 300px; }
    .leaflet-container { font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // === Your published CSV ===
    // If you change tabs, update gid accordingly.
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-ZxzOQMY6WOlSdttZWaxy-UUQEXdnHEvdXcuRoqDlek4ziPNTSgMgvq-NinaaCuezJ7vzBlm3hOMO/pubhtml?gid=0&single=true";

    // Initialize map (always start over USA)
    const map = L.map('map', { scrollWheelZoom: true }).setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load CSV and place markers
    Papa.parse(SHEET_CSV + "&_ts=" + Date.now(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const rows = (results.data || []).filter(r => r && Object.keys(r).length);
        console.log("Loaded rows:", rows.length, "Columns:", Object.keys(rows[0] || {}));

        rows.forEach(r => {
          // Be forgiving about header capitalization
          const title   = (r.title || r.Title || "Untitled Event").toString().trim();
          const start   = (r.start || r.Start || "").toString().trim();
          const end     = (r.end   || r.End   || "").toString().trim();
          const where   = (r.location || r.Location || "").toString().trim();
          const link    = (r.htmlLink || r.HtmlLink || r.Link || "").toString().trim();
          const rawDesc = (r.description || r.Description || "").toString();

          // lat/lng must be numeric
          const lat = parseFloat((r.lat || r.Lat || r.Latitude || "").toString().trim());
          const lng = parseFloat((r.lng || r.Lng || r.Long || r.Longitude || "").toString().trim());
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          // Build popup (escape first, then linkify; format dates to Month Day, Year, h:mm AM/PM)
          const when = formatDate(start) + (end ? " â€“ " + formatDate(end) : "");
          const desc = linkify(escapeHtml(rawDesc));

          const popupHtml =
            `<div class="popup">
               <h3>${escapeHtml(title)}</h3>
               ${when ? `<div class="meta"><strong>When:</strong> ${when}</div>` : ""}
               ${where ? `<div class="meta"><strong>Where:</strong> ${escapeHtml(where)}</div>` : ""}
               ${link ? `<div class="meta"><a href="${encodeURI(link)}" target="_blank" rel="noopener">View in Google Calendar</a></div>` : ""}
               ${rawDesc ? `<div class="desc">${desc}</div>` : ""}
             </div>`;

          L.marker([lat, lng]).addTo(map).bindPopup(popupHtml);
        });

        // We intentionally do NOT fitBounds; we keep the default USA view.
      },
      error: function(err) {
        console.error("CSV load error:", err);
        alert("Could not load event data. Make sure your sheet tab is published as CSV.");
      }
    });

    // Helpers
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
    }
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return escapeHtml(dateStr); // fallback to raw if parsing fails
      return d.toLocaleString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }
  </script>
</body>
</html>
