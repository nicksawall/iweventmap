<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Irreverent Warriors Event Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Papa Parse (robust CSV parsing) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .popup h3 { margin: 0 0 4px; font-size: 16px; }
    .popup .meta { font-size: 13px; margin: 2px 0; color: #333; }
    .popup .desc { margin-top: 6px; white-space: pre-wrap; max-width: 320px; }
    .leaflet-container { font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ---------- Helpers (define BEFORE use) ----------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return escapeHtml(dateStr); // fallback if parsing fails
      return d.toLocaleString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }

    // Look up a value using multiple possible header names (case/space-insensitive)
    function getVal(row, names) {
      for (const n of names) {
        const k = Object.keys(row).find(k => k && k.trim().toLowerCase() === n.toLowerCase());
        if (k && row[k] != null && String(row[k]).trim() !== "") return row[k];
      }
      return "";
    }

    // ---------- Config ----------
    // Use your published CSV link (works as-is); if you change tabs, update gid.
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-ZxzOQMY6WOlSdttZWaxy-UUQEXdnHEvdXcuRoqDlek4ziPNTSgMgvq-NinaaCuezJ7vzBlm3hOMO/pub?gid=0&single=true&output=csv";

    // ---------- Map setup (always start over USA) ----------
    const map = L.map('map', { scrollWheelZoom: true }).setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ---------- Load CSV & add markers ----------
    Papa.parse(SHEET_CSV + "&_ts=" + Date.now(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const rows = (results.data || []).filter(r => r && Object.keys(r).length);
        const cols = Object.keys(rows[0] || {}).map(c => c.trim());
        console.log("Loaded rows:", rows.length, "Columns:", cols);

        rows.forEach(r => {
          const title   = (getVal(r, ["title","Title"]) || "Untitled Event").toString().trim();
          const start   = (getVal(r, ["start","Start"]) || "").toString().trim();
          const end     = (getVal(r, ["end","End"])     || "").toString().trim();
          const where   = (getVal(r, ["location","Location"]) || "").toString().trim();
          const link    = (getVal(r, ["htmlLink","HtmlLink","link","Link"]) || "").toString().trim();
          const rawDesc = (getVal(r, ["description","Description"]) || "").toString();

          // Accept many possible lat/lng header names
          const latStr = (getVal(r, ["lat","Lat","latitude","Latitude","y","Y","geo_lat","Geo_Lat"]) || "").toString().trim();
          const lngStr = (getVal(r, ["lng","Lng","long","Long","lon","Lon","longitude","Longitude","x","X","geo_lng","Geo_Lng"]) || "").toString().trim();
          const lat = parseFloat(latStr);
          const lng = parseFloat(lngStr);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return; // skip rows without coords

          const when = formatDate(start) + (end ? " â€“ " + formatDate(end) : "");
          const desc = linkify(escapeHtml(rawDesc));

          const popupHtml =
            `<div class="popup">
               <h3>${escapeHtml(title)}</h3>
               ${when ? `<div class="meta"><strong>When:</strong> ${when}</div>` : ""}
               ${where ? `<div class="meta"><strong>Where:</strong> ${escapeHtml(where)}</div>` : ""}
               ${link ? `<div class="meta"><a href="${encodeURI(link)}" target="_blank" rel="noopener">View in Google Calendar</a></div>` : ""}
               ${rawDesc ? `<div class="desc">${desc}</div>` : ""}
             </div>`;

          L.marker([lat, lng]).addTo(map).bindPopup(popupHtml);
        });

        // We intentionally keep the default USA view (no fitBounds).
      },
      error: function(err) {
        console.error("CSV load error:", err);
        alert("Could not load event data. Make sure your sheet tab is published as CSV.");
      }
    });
  </script>
</body>
</html>
