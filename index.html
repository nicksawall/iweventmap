<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Irreverent Warriors Event Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Papa Parse (robust CSV parsing) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 360px 1fr; gap: 0; height: 100vh; }
    #sidebar { border-right: 1px solid #e5e5e5; padding: 12px; overflow: auto; }
    #map { height: 100vh; width: 100%; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    .controls button, .controls select { padding: 6px 10px; font-size: 14px; }
    .legend { display: flex; gap: 10px; font-size: 13px; margin: 8px 0 12px; flex-wrap: wrap; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: middle; }
    .item { padding: 8px 6px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; cursor: pointer; }
    .item h4 { margin: 0 0 4px; font-size: 15px; }
    .meta { font-size: 13px; color: #444; }
    .popup h3 { margin: 0 0 4px; font-size: 16px; }
    .popup .meta { font-size: 13px; margin: 2px 0; color: #333; }
    .popup .desc { margin-top: 6px; white-space: pre-wrap; max-width: 320px; }
    .leaflet-container { font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      #sidebar { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <div class="controls">
        <button id="locBtn" title="Use my location">üìç Use My Location</button>
        <select id="sortSel" title="Sort">
          <option value="date">Sort by Date</option>
          <option value="distance">Sort by Distance</option>
        </select>
      </div>

      <div class="legend">
        <span><span class="dot" style="background:#9aa0a6;"></span>Past</span>
        <span><span class="dot" style="background:#f2994a;"></span>Next 30 days</span>
        <span><span class="dot" style="background:#34a853;"></span>Upcoming</span>
      </div>

      <div id="list"></div>
    </aside>
    <div id="map"></div>
  </div>

  <script>
    // ---------- Helpers ----------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
    }
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return escapeHtml(dateStr); // fallback if parsing fails
      return d.toLocaleString("en-US", {
        month: "long", day: "numeric", year: "numeric",
        hour: "numeric", minute: "2-digit", hour12: true
      });
    }
    function getVal(row, names) {
      for (const n of names) {
        const k = Object.keys(row).find(k => k && k.trim().toLowerCase() === n.toLowerCase());
        if (k && row[k] != null && String(row[k]).trim() !== "") return row[k];
      }
      return "";
    }
    // Haversine distance in miles
    function distanceMiles(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180;
      const R = 3958.7613; // Earth radius in miles
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }
    function classifyByDate(startISO) {
      const now = new Date();
      const start = new Date(startISO);
      if (isNaN(start)) return {status: 'unknown', color: '#3367d6'}; // fallback blue
      if (start < now) return {status: 'past', color: '#9aa0a6'};     // gray
      const days = (start - now) / (1000*60*60*24);
      if (days <= 30) return {status: 'soon', color: '#f2994a'};      // orange
      return {status: 'upcoming', color: '#34a853'};                  // green
    }

    // ---------- Config ----------
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-ZxzOQMY6WOlSdttZWaxy-UUQEXdnHEvdXcuRoqDlek4ziPNTSgMgvq-NinaaCuezJ7vzBlm3hOMO/pub?gid=0&single=true&output=csv";

    // ---------- Map ----------
    const map = L.map('map', { scrollWheelZoom: true }).setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ---------- Data & UI state ----------
    let userLoc = null;    // {lat, lng}
    let events = [];       // [{...parsed, marker, distanceMiles}]
    const listEl = document.getElementById('list');
    const sortSel = document.getElementById('sortSel');
    const locBtn  = document.getElementById('locBtn');

    locBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert("Geolocation isn‚Äôt supported by your browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          L.circleMarker([userLoc.lat, userLoc.lng], {
            radius: 6, color: '#1976d2', weight: 2, fillColor: '#1976d2', fillOpacity: 0.6
          }).addTo(map).bindPopup('You are here').openPopup();
          // compute distances + resort list
          recomputeDistances();
          renderList();
        },
        err => {
          alert("Couldn‚Äôt get your location (" + err.message + "). You can still browse by date.");
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
      );
    });

    sortSel.addEventListener('change', () => renderList());

    // ---------- Load CSV & add markers ----------
    Papa.parse(SHEET_CSV + "&_ts=" + Date.now(), {
      download: true, header: true, skipEmptyLines: true,
      complete: function(results) {
        const rows = (results.data || []).filter(r => r && Object.keys(r).length);
        console.log("Loaded rows:", rows.length, "Columns:", Object.keys(rows[0] || {}));
        events = rows.map(r => rowToEvent(r)).filter(Boolean);
        renderMarkers();
        renderList();
      },
      error: function(err) {
        console.error("CSV load error:", err);
        alert("Could not load event data. Make sure your sheet tab is published as CSV.");
      }
    });

    function rowToEvent(r) {
      const title   = (getVal(r, ["title","Title"]) || "Untitled Event").toString().trim();
      const start   = (getVal(r, ["start","Start"]) || "").toString().trim();
      const end     = (getVal(r, ["end","End"])     || "").toString().trim();
      const where   = (getVal(r, ["location","Location"]) || "").toString().trim();
      const link    = (getVal(r, ["htmlLink","HtmlLink","link","Link"]) || "").toString().trim();
      const rawDesc = (getVal(r, ["description","Description"]) || "").toString();

      const latStr = (getVal(r, ["lat","Lat","latitude","Latitude","y","Y","geo_lat","Geo_Lat"]) || "").toString().trim();
      const lngStr = (getVal(r, ["lng","Lng","long","Long","lon","Lon","longitude","Longitude","x","X","geo_lng","Geo_Lng"]) || "").toString().trim();
      const lat = parseFloat(latStr);
      const lng = parseFloat(lngStr);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;

      const when = formatDate(start) + (end ? " ‚Äì " + formatDate(end) : "");
      const desc = linkify(escapeHtml(rawDesc));
      const klass = classifyByDate(start);

      return {
        title, start, end, when, where, link, rawDesc, desc, lat, lng,
        color: klass.color, status: klass.status, distance: null
      };
    }

    function renderMarkers() {
      events.forEach(ev => {
        const popupHtml =
          `<div class="popup">
             <h3>${escapeHtml(ev.title)}</h3>
             ${ev.when ? `<div class="meta"><strong>When:</strong> ${ev.when}</div>` : ""}
             ${ev.where ? `<div class="meta"><strong>Where:</strong> ${escapeHtml(ev.where)}</div>` : ""}
             ${ev.link ? `<div class="meta"><a href="${encodeURI(ev.link)}" target="_blank" rel="noopener">View in Google Calendar</a></div>` : ""}
             ${ev.rawDesc ? `<div class="desc">${ev.desc}</div>` : ""}
           </div>`;
        ev.marker = L.circleMarker([ev.lat, ev.lng], {
          radius: 8, color: ev.color, weight: 2, fillColor: ev.color, fillOpacity: 0.85
        }).addTo(map).bindPopup(popupHtml);
      });
    }

    function recomputeDistances() {
      if (!userLoc) return;
      events.forEach(ev => {
        ev.distance = distanceMiles(userLoc.lat, userLoc.lng, ev.lat, ev.lng);
      });
    }

    function renderList() {
      // compute distance if possible
      if (userLoc) recomputeDistances();

      // sort
      const sortMode = sortSel.value;
      const sorted = [...events];
      if (sortMode === 'distance' && userLoc) {
        sorted.sort((a,b) => (a.distance ?? Infinity) - (b.distance ?? Infinity));
      } else {
        // default by start date then title
        sorted.sort((a,b) => {
          const da = new Date(a.start), db = new Date(b.start);
          const t = (isNaN(da) ? Infinity : da) - (isNaN(db) ? Infinity : db);
          return t !== 0 ? t : a.title.localeCompare(b.title);
        });
      }

      // render items
      listEl.innerHTML = '';
      sorted.forEach(ev => {
        const dist = (userLoc && Number.isFinite(ev.distance)) ? ` ‚Ä¢ ${ev.distance.toFixed(1)} mi` : '';
        const statusDot = `<span class="dot" style="background:${ev.color};"></span>`;
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <h4>${statusDot}${escapeHtml(ev.title)}</h4>
          <div class="meta">${ev.when || ''}${dist}</div>
          ${ev.where ? `<div class="meta">${escapeHtml(ev.where)}</div>` : ''}
          ${ev.link ? `<div class="meta"><a href="${encodeURI(ev.link)}" target="_blank" rel="noopener">Open in Google Calendar</a></div>` : ''}
        `;
        item.addEventListener('click', () => {
          if (ev.marker) {
            map.setView([ev.lat, ev.lng], 11);
            ev.marker.openPopup();
          }
        });
        listEl.appendChild(item);
      });
    }
  </script>
</body>
</html>
