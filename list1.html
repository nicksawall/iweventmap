<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IW Event List (Embed)</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js" defer></script>
<style>
  :root{--gap:1rem;--border:#e8ebf0;--muted:#5e6470;--text:#1c1d20;--accent:#b40000;--radius:12px;--shadow:0 6px 16px rgba(0,0,0,.06)}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem}
  h2{margin:0 0 1rem;font-size:clamp(1.2rem,1.8vw,1.6rem)}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:var(--gap)}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);background:#fff;overflow:clip;display:grid;grid-template-rows:auto 1fr auto}
  .card .top{display:flex;align-items:center;gap:.8rem;padding:.9rem .9rem .2rem}
  .date-badge{border:1px solid var(--border);border-radius:10px;padding:.4rem .6rem;text-align:center;min-width:64px;line-height:1.1}
  .date-badge .mon{font-size:.7rem;letter-spacing:.08em;color:var(--muted);text-transform:uppercase}
  .date-badge .day{font-size:1.2rem;font-weight:700}
  .title{font-weight:700;font-size:1.05rem;line-height:1.25}
  .desc{padding:0 .9rem .9rem;color:#2b2f36;font-size:.95rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
  .actions{display:flex;gap:.5rem;padding:.9rem;border-top:1px solid var(--border);background:#fafbfc;flex-wrap:wrap}
  .btn{appearance:none;text-decoration:none;border:1px solid var(--border);padding:.55rem .75rem;border-radius:10px;font-weight:600;font-size:.95rem;color:var(--text);background:#fff}
  .btn.primary{border-color:var(--accent);background:var(--accent);color:#fff}
  .empty{color:var(--muted);text-align:center;padding:2rem 0}
</style>
</head>
<body>
<div class="wrap">
  <h2>Upcoming Irreverent Warriors Events</h2>
  <div id="events" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>No upcoming events found.</div>
</div>

<script>
  // ===== CONFIG =====
  // Use your published-to-web CSV URL for the correct tab:
  const BASE_FEED_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-ZxzOQMY6WOlSdttZWaxy-UUQEXdnHEvdXcuRoqDlek4ziPNTSgMgvq-NinaaCuezJ7vzBlm3hOMO/pub?gid=0&single=true&output=csv";
  const FEED_URL = BASE_FEED_URL + "&cachebust=" + Date.now(); // avoid stale cache

  // Lowercase headers from your sheet
  const FIELDS = {
    id: "eventId",
    title: "title",
    start: "start",
    end:   "end",
    location: "location",
    url:   "htmlLink",     // not used for the button anymore, but left for reference
    desc:  "description",
    lat:   "lat",
    lng:   "lng"
  };

  // ===== UTIL =====
  const grid = document.getElementById("events");
  const empty = document.getElementById("empty");

  // Robust date parser: ISO, US (M/D/YYYY HH:MM [AM/PM]), date-only (D-M-YYYY / D.M.YYYY)
  function toDate(v){
    if (!v) return null;
    let d = new Date(v);
    if (!isNaN(d)) return d;
    const s = String(v).trim();

    // US: M/D/YYYY [HH:MM] [AM|PM]
    let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?:\s*(AM|PM))?)?$/i);
    if (m){
      let [, M, D, Y, h="0", min="0", ap] = m;
      M = +M; D = +D; Y = +Y; h = +h; min = +min;
      if (ap){
        ap = ap.toUpperCase();
        if (ap === "PM" && h < 12) h += 12;
        if (ap === "AM" && h === 12) h = 0;
      }
      d = new Date(Y, M-1, D, h, min);
      if (!isNaN(d)) return d;
    }

    // Date-only D-M-YYYY or D.M.YYYY
    m = s.match(/^(\d{1,2})[.-](\d{1,2})[.-](\d{4})$/);
    if (m){
      const [, D, M, Y] = m.map(Number);
      d = new Date(Y, M-1, D);
      if (!isNaN(d)) return d;
    }
    return null;
  }

  function fmtPieces(d){ return {
    mon: d.toLocaleString([], {month:"short"}),
    day: d.getDate(),
    time: d.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"})
  };}

  function isUpcoming(start, end){
    const now = new Date();
    if (end) return end >= now;
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return start >= today;
  }

  const escapeHtml = s => String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  const slug = s => String(s||"event").toLowerCase()
    .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");

  // Turn URLs in text into links (after we strip the first one)
  const linkify = t => escapeHtml(t).replace(
    /(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>'
  );

  // Extract the FIRST URL and remove that one from the text (leave others)
  function extractFirstUrlAndStrip(text){
    if (!text) return { url: "", text: "" };
    const s = String(text);
    const rx = /(https?:\/\/[^\s]+)/i;
    const m = s.match(rx);
    if (!m) return { url: "", text: s };
    const url = m[0];
    // Remove only the first match, keep the rest for linkify
    const stripped = s.replace(url, "").replace(/\s{2,}/g, " ").trim();
    return { url, text: stripped };
  }

  function makeICS(ev){
    if (!ev || !ev.startDate || isNaN(ev.startDate)) return "";
    const dt = d=>d.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
    const uid = (ev.id ? ev.id : `${Date.now()}-${Math.random().toString(36).slice(2)}`) + "@irreverentwarriors.com";
    const lines = [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Irreverent Warriors//Events//EN","BEGIN:VEVENT",
      `UID:${uid}`,`DTSTAMP:${dt(new Date())}`,`DTSTART:${dt(ev.startDate)}`,
      ev.endDate?`DTEND:${dt(ev.endDate)}`:null,
      `SUMMARY:${(ev.title||"IW Event").replace(/\n/g," ")}`,
      "END:VEVENT","END:VCALENDAR"
    ].filter(Boolean).join("\r\n");
    return "data:text/calendar;charset=utf-8,"+encodeURIComponent(lines);
  }

  // ===== RENDER =====
  function render(events){
    grid.innerHTML = "";
    if (!events.length){ empty.hidden = false; return; }
    empty.hidden = true;

    const frag = document.createDocumentFragment();
    for (const ev of events){
      const {mon,day} = fmtPieces(ev.startDate);

      // Pull first URL from description, and strip it from the body
      const { url: detailUrl, text: strippedDesc } = extractFirstUrlAndStrip(ev.desc || "");

      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <div class="top">
          <div class="date-badge" aria-label="${ev.startDate.toDateString()}">
            <div class="mon">${mon}</div><div class="day">${day}</div>
          </div>
          <div><div class="title">${escapeHtml(ev.title||"Untitled Event")}</div></div>
        </div>
        ${strippedDesc ? `<div class="desc">${linkify(strippedDesc)}</div>` : ""}
        <div class="actions">
          ${detailUrl ? `<a class="btn primary" href="${detailUrl}" target="_blank" rel="noopener">Register Here!</a>` : ""}
          ${ev.addIcs ? `<a class="btn" href="${ev.addIcs}" download="${slug(ev.title)}.ics">Add to Calendar</a>` : ""}
        </div>`;
      frag.appendChild(card);
    }
    grid.appendChild(frag);
    notifySize();
  }

  // ===== AUTOSIZE for iframe =====
  function notifySize(){
    const h = document.documentElement.scrollHeight || document.body.scrollHeight;
    window.parent?.postMessage({type:"IW_EMBED_HEIGHT", id:"iw-list", height:h}, "*");
  }
  new ResizeObserver(()=>notifySize()).observe(document.body);
  window.addEventListener("load", ()=> setTimeout(notifySize, 50));

  // ===== LOAD DATA =====
  window.addEventListener("load", ()=>{
    Papa.parse(FEED_URL, {
      download:true, header:true, skipEmptyLines:true,
      complete:(res)=>{
        const rows = res.data || [];
        const all = [];

        for (const r of rows){
          const start = toDate(r[FIELDS.start]);
          const end   = toDate(r[FIELDS.end]);
          if (!start || isNaN(start)) continue; // skip rows with invalid/missing start

          const ev = {
            id:   r[FIELDS.id]   || "",
            title:r[FIELDS.title]|| "",
            location:r[FIELDS.location] || "",
            url:  r[FIELDS.url]  || "",  // not used for button now
            desc: r[FIELDS.desc] || "",
            startDate:start,
            endDate:end
          };
          ev.addIcs = makeICS(ev);
          all.push(ev);
        }

        const upcoming = all.filter(e => isUpcoming(e.startDate, e.endDate));
        upcoming.sort((a,b)=>a.startDate - b.startDate);
        render(upcoming);
      },
      error:(err)=>{
        console.error("CSV error:", err);
        empty.hidden = false; empty.textContent = "Could not load events.";
        notifySize();
      }
    });
  });
</script>
</body>
</html>
